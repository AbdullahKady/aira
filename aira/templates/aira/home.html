{% extends 'base.html' %}
{% load bootstrap3 %}

{% block title %} Home - {{user}} {% endblock %}

{% block content %}
{% if not profile %}
  <div class="alert alert-warning">
    <a href="#" class="close" data-dismiss="alert">&times;</a><i class="fa fa-hand-o-right"></i> &nbsp; Please update your pernonal information<a href="{% url 'create_profile' %}"> here </a>
  </div>
{% endif %}
<!-- context['map'] -->
<div class="panel panel-default">
  <div class="panel-heading"></div>
    <div class="panel-body">
      <div id="open_map" class="map"></div>
       <script type="text/javascript">
          // Map object
          map = new OpenLayers.Map('open_map',
                    {units: 'm',
                     displayProjection: 'EPSG:4326',
                     controls: [new OpenLayers.Control.LayerSwitcher(),
                                new OpenLayers.Control.Zoom(),
                                new OpenLayers.Control.Navigation(),
                                new OpenLayers.Control.MousePosition({prefix:'Coordinates(EPSG:3857): '}),
                                new OpenLayers.Control.ScaleLine()]
                     });
          // Open Cycle
          var cycle = new OpenLayers.Layer.OSM.CycleMap(
                        "Open Cycle Map",
                        {isBaseLayer: true,
                         projection: 'EPSG:3857'});
          // OSM to be changed by Ktimatologio
          var osm = new OpenLayers.Layer.OSM();
          map.addLayers([cycle, osm]);
          {% for f in agrifields %}
            var agrifield_point = new OpenLayers.LonLat({{f.longitude}}, {{f.latitude}}).transform('EPSG:4326', 'EPSG:3857');
            var markers = new OpenLayers.Layer.Markers("{{f.name}}");
            markers.addMarker(new OpenLayers.Marker(agrifield_point));
            map.addLayer(markers);
            map.setCenter (new OpenLayers.LonLat(20.98, 39.15).transform('EPSG:4326', 'EPSG:3857'), 10);
          {% empty %}
            var arta = new OpenLayers.LonLat(20.98, 39.15).transform('EPSG:4326', 'EPSG:3857');
            map.setCenter(new OpenLayers.LonLat(20.98, 39.15).transform('EPSG:4326', 'EPSG:3857'), 10);
          {% endfor %}
       </script>
      </div>
      {% if profile %}
        <div class="panel-footer">
          <strong>First name:</strong> <a href="{% url 'update_profile' profile.id %}">{{ profile.first_name }}</a><br>
          <strong>Last name :</strong> <a href="{% url 'update_profile' profile.id %}">{{ profile.last_name }}</a><br>
          <strong>Address:</strong>
          {% if profile.address %}
            <a href="{% url 'update_profile' profile.id %}">{{ profile.address }}</a><br>
          {% else %}
            <a href="{% url 'update_profile' profile.id %}"> [edit] </a><br>
          {% endif %}
        </div>
      {% endif %}
</div>
{% if not agrifields %}
  <div class="alert alert-warning">
    <a href="#" class="close" data-dismiss="alert">&times;</a>
    <i class="fa fa-exclamation-triangle"></i> &nbsp; Hmmm, it seems you have't any fields, Add at least one <a href="{% url 'create_agrifield' %}"> here </a>
  </div>
{% else %}
  <div class="panel panel-default">
    <div class="panel-heading">
      <a class="btn btn-success btn-xs" href="{% url 'create_agrifield' %}"><i class="fa fa-plus-square-o"></i>&nbsp;<i class="fa fa-minus-square-o"></i>&nbsp; Agrifields</a>
    </div>
    {% for f in agrifields %}
      <div class="panel-body">
        <p><b>Field Info:</b> &nbsp;<a href="{% url 'update_agrifield' f.id %}">{{ f.name }}</a> is growing <a href="{% url 'update_agrifield' f.id %}">{{ f.ct.ct_name }}</a> using <a href="{% url 'update_agrifield' f.id %}">{{ f.irrt.irrt_name }}</a>. </p>
        {% if f.outside_arta_raster %}
          <div class="alert alert-danger">
            <a href="#" class="close" data-dismiss="alert">&times;</a><span class="label label-danger"><i class="fa fa-exclamation-triangle">&nbsp;Warning</i></span> &nbsp;
             Your agrifield location is outside Arta's plain field. <br>
             Update you field location <a href="{% url 'update_agrifield' f.id %}">here</a>.
          </div>

        {% else %}
          {% if not f.irr_event %}
            <div class="alert alert-warning">
              <a href="#" class="close" data-dismiss="alert">&times;</a><span class="label label-warning"><i class="fa fa-exclamation-triangle ">&nbsp;Warning</i></span>  &nbsp;
              You haven't entered any irrigation event. Add  your irrigation log <a href="{% url 'create_irrlog' f.id %}">here</a>.<br>
              Irrigation Advice is estimated using aira default datasets.
            </div>
          {% endif %}
          {% if f.last_irr_event_outside_period %}
            <div class="alert alert-warning">
              <a href="#" class="close" data-dismiss="alert">&times;</a><span class="label label-warning"><i class="fa fa-exclamation-triangle ">&nbsp;Warning</i></span>  &nbsp;
              Your latest irrigation event is outside our dataset period. Update your irrigation log <a href="{% url 'create_irrlog' f.id %}">here</a>.<br>
              Irrigation Advice is estimated using aira default datasets.
            </div>
          {% endif %}
          {% if f.over_fc %}
            <div class="alert alert-info">
              <a href="#" class="close" data-dismiss="alert">&times;</a><i class="fa fa-exclamation-triangle "></i>
                You reached field capacity ({{ f.fc_mm|floatformat:"1" }} mm)</a>.
            </div>
          {% endif %}
            <p><b>Irrigation Advice:</b>
              {% if f.adv %}
                <div class="table-responsive">
                  <table class="table">
                      <thead>
                        <tr>
                          <th>Date <br> </th>
                          <th>Irrigation Water Amount<br> (mm)</th>
                        </tr>
                      </thead>
                       <tbody>
                          {% for irri_event in f.adv %}
                            <tr>
                              <td align="center">{{ irri_event.date |date:"d/m/Y h:m:s" }}</td>
                              <td align="center">{{ irri_event.Ifinal|floatformat:"2" }}</td>
                            </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
              {% else %}
                No need to irrigate from <span <class class="text-warning">{{ f.sd }}</span> to  <span <class class="text-warning">{{ f.ed }}</span>.
              {% endif %}

            </p>
            <sub><a class="btn btn-success btn-xs" href="{% url 'advice' f.id %}" target="_blank"></i>&nbsp;<i class="fa fa-calendar"></i>&nbsp;Detailed Report</a>
            <a class="btn btn-success btn-xs" href="{% url 'create_irrlog' f.id %}"><i class="fa fa-plus-square-o"></i>&nbsp;<i class="fa fa-minus-square-o"></i>&nbsp; TimeLogs</a>
            </sub></p>
        {% endif %}
        <hr class="bhr">
      </div>
    {% endfor %}
{% endif %}
{% endblock %}
