{% extends 'base.html' %}
{% load i18n %}

{% load bootstrap3 %}
{% block title %} {{ user }}-{% trans "Update" %} {% trans "Field" %}{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4>{% trans "Update" %} {% trans "Field" %}</h4>
      </div>
      <div class="panel panel-body">
        <div class="col-md-12">
        <div id="on_clink_map" class="map"></div>
            <script>
              function make_coords(coord) {
                  return parseFloat(coord.replace(",","."));
                };

                map = new OpenLayers.Map('on_clink_map',
                      {units: 'm',
                       displayProjection: 'EPSG:4326',
                       maxResolution: 0.04612890625,
                       controls: [
                                  new OpenLayers.Control.LayerSwitcher(),
                                  new OpenLayers.Control.Zoom(),
                                  new OpenLayers.Control.Navigation(),
                                  new OpenLayers.Control.MousePosition(),
                                  new OpenLayers.Control.ScaleLine()]
                       });
                // Open Cycle
                var cycle = new OpenLayers.Layer.OSM.CycleMap(
                          "Open Cycle Map",
                          {isBaseLayer: true,
                           projection: 'EPSG:3857'});

                var ktimatologio = new OpenLayers.Layer.WMS("Hellenic Cadastre",
                         "http://gis.ktimanet.gr/wms/wmsopen/wmsserver.aspx",
                           {   layers: 'KTBASEMAP', transparent: false},
                           {   isBaseLayer: true,
                               numZoomLevels: 24,
                               projection: new OpenLayers.Projection("EPSG:900913"),
                               iformat: 'image/png'});
                map.addLayer(ktimatologio);
                map.addLayer(cycle);
                //alert(parseFloat("{{ object.longitude }}".replace(",",".")));
                var fieldloc = new OpenLayers.LonLat(make_coords("{{ object.longitude }}"),make_coords("{{ object.latitude }}")).transform('EPSG:4326', 'EPSG:3857');
                var marker = new OpenLayers.Marker(fieldloc)
                var markers = new OpenLayers.Layer.Markers( "{{ object.name }}" );
                map.addLayer(markers);
                markers.addMarker(marker);
                map.setCenter(fieldloc, 20);
                map.events.register("click", map , function(e){
                var opx = map.getLonLatFromPixel(e.xy) ;
                var marker = new OpenLayers.Marker(opx);
                markers.clearMarkers();
                markers.addMarker(marker);
                var lonlat = map.getLonLatFromPixel(e.xy).transform('EPSG:3857', 'EPSG:4326');
                document.getElementById("id_latitude").value = lonlat.lat.toFixed(5);
                document.getElementById("id_longitude").value = lonlat.lon.toFixed(5);
                });

                $(document).ready(function(){
                    $("#id_use_custom_parameters").click(function(){
                        $("#custom_par").stop().toggle();
                    });
                });

          </script>
      <sub> {% trans "Click on Map to add your Field coordinates" %}</sub>
      <hr>
      <fieldset>
          <form method="post" role="form">
          {% csrf_token %}
          <div class='row'>
              <div class='col-sm-6'>
                  <div class='form-group'>
                  {% bootstrap_field form.name %}
                  {% bootstrap_field form.area %}
                  {% bootstrap_field form.longitude %}
                  {% bootstrap_field form.latitude %}
                  {% bootstrap_field form.crop_type %}
                  {% bootstrap_field form.irrigation_type %}
                  {% bootstrap_field form.irrigation_optimizer %}
                  {% bootstrap_field form.use_custom_parameters %}
                  </div>
                  {% buttons %}
                  <button type="submit" class="btn btn-success btn-xs">{% trans "Add" %}</button>
                  <a class="btn btn-success btn-xs" href="{% url 'home' %}"> {% trans "Back" %} </a>
                  {% endbuttons %}
              </div>
              <div class='col-sm-6'>
              {% if object.use_custom_parameters %}
                  <div class='form-group' style="display:block" id="custom_par">
              {% else %}
                  <div class='form-group' style="display:none" id="custom_par">
              {% endif %}
                      {% bootstrap_field form.custom_irrigation_optimizer%}
                      <sup>*{% trans "Value from system's database" %}: <span class="text-success"><b>1.0</b></span></sup>
                      {% bootstrap_field form.custom_kc %}
                      <sup>*{% trans "Value from system's database" %}: <span class="text-success"><b>{{ default_parms.kc }}</b></span></sup>
                      {% bootstrap_field form.custom_root_depth_max %}
                      <sup>*{% trans "Value from system's database" %}: <span class="text-success"><b>{{ default_parms.rd_max}}</b></span></sup>
                      {% bootstrap_field form.custom_root_depth_min %}
                      <sup>*{% trans "Value from system's database" %}: <span class="text-success"><b>{{ default_parms.rd_min }}</b></span></sup>
                      {% bootstrap_field form.custom_max_allow_depletion %}
                      <sup>*{% trans "Value from system's database" %}: <span class="text-success"><b>{{ default_parms.mad }}</b></span></sup>
                      {% bootstrap_field form.custom_efficiency %}
                      <sup>*{% trans "Value from system's database" %}: <span class="text-success"><b>{{ default_parms.irr_eff }}</b></span></sup>
              </div>
            </div>
        </form>
      </fieldset>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
