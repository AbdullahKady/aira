{% extends 'base.html' %}
{% load bootstrap3 %}

{% block title %} {{ user }} - Add Field {% endblock %}

{% block content %}
{% if fields_count %}
  <div class="alert alert-warning">
    <a href="#" class="close" data-dismiss="alert">&times;</a>
    <i class="fa fa-hand-o-right fa-1x"></i>&nbsp;  You have <b><span class="text text-success">{{fields_count}}</span></b> Field(s) in your database.
  </div>
{% endif %}
<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h4>Add Field</h4>
      </div>
      <div class="panel panel-body">
        <div class="col-md-6">
        <div id="on_clink_map" class="map"></div>
      <script>
          map = new OpenLayers.Map('on_clink_map',
                {units: 'm',
                 displayProjection: 'EPSG:4326',
                 controls: [new OpenLayers.Control.LayerSwitcher(),
                            new OpenLayers.Control.Navigation(),
                            new OpenLayers.Control.Zoom(),
                            new OpenLayers.Control.MousePosition({prefix:'Coordinates(EPSG:3857): '}),
                            new OpenLayers.Control.ScaleLine()]
                 });
          // Open Cycle
          var cycle = new OpenLayers.Layer.OSM.CycleMap(
                    "Open Cycle Map",
                    {isBaseLayer: true,
                     projection: 'EPSG:3857'});
          // Kthmatologio
          var ktimatologio = new OpenLayers.Layer.WMS("Hellinic Cadastre",
                         "http://gis.ktimanet.gr/wms/wmsopen/wmsserver.aspx",
                           {   layers: 'KTBASEMAP', transparent: false},
                           {   isBaseLayer: true,
                               projection: new OpenLayers.Projection("EPSG:900913"),
                               iformat: 'image/png'});
          map.addLayers([cycle, ktimatologio]);
          map.setCenter(new OpenLayers.LonLat(20.98, 39.15).transform('EPSG:4326', 'EPSG:3857'), 9);
          // Create Marker
          var markers = new OpenLayers.Layer.Markers( "Add new Field" );
          map.addLayer(markers);
          // Display Marker
          map.events.register("click", map , function(e){
                      var opx = map.getLonLatFromPixel(e.xy) ;
                      var marker = new OpenLayers.Marker(opx);
                      markers.clearMarkers();
                      markers.addMarker(marker);
                      var lonlat = map.getLonLatFromPixel(e.xy).transform('EPSG:3857', 'EPSG:4326');
                      document.getElementById("id_latitude").value = lonlat.lat.toFixed(3);
                      document.getElementById("id_longitude").value = lonlat.lon.toFixed(3);
          });
      </script>
    <sub> Click on Map to add your Field coordinates</sub>
        </div>
        <div class="col-md-6">
          <form method="post" role="form">
            {% csrf_token %}
            {% bootstrap_form form %}
            {% buttons %}
              <button type="submit" class="btn btn-success btn-xs">Add</button>
            {% endbuttons %}
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-lg-12">
    <div class="panel panel-default">
      <div class="panel-heading">
      <h4> List of Fields</h4>
      </div>
      <div class="panel panel-body">
            <div class="table-responsive">
              <table class="table">
                  <thead>
                    <tr>
                      <th>#id</th>
                      <th>Name</th>
                      <th>Crop Type</th>
                      <th>Irrigation Type</th>
                      <th>TimeLogs</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% for f in agrifields  %}
                    <tr>
                      <td>{{ f.id }}</td>
                      <td><a href="{% url 'update_agrifield' f.id%}">{{f.name}}</a></td>
                      <td><a href="{% url 'update_agrifield' f.id%}">{{f.ct.ct_name}}</td>
                      <td><a href="{% url 'update_agrifield' f.id%}">{{f.irrt.irrt_name}}</a></td>
                      <td><a href="{% url 'create_irrlog' f.id %}"><i class="fa fa-plus-square-o"></i>&nbsp;<i class="fa fa-minus-square-o"></i></a></td>
                      <td><a href="{% url 'delete_agrifield' f.id %}">Delete </a></td>
                    </tr>
                  {% empty %}
                    <div class="alert alert-warning">
                      <a href="#" class="close" data-dismiss="alert">&times;</a>
                      <i class="fa fa-hand-o-right fa-1x"></i>&nbsp;  Nothing to show without any agrifields.
                    </div>
                  {% endfor %}
                  </tbody>
              </table>
            </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
